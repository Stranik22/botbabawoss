import asyncio
import logging
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
import aiohttp
import os
from io import BytesIO

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π)
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"
# API –∫–ª—é—á Nano Banana Pro
NANO_API_KEY = "104fd7bddfdad824400625c449141c16"

bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class FurnitureStates(StatesGroup):
    waiting_prompt = State()
    waiting_furniture_edit = State()
    waiting_room_photo = State()

# –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–º—Ç—ã
FURNITURE_PROMPT = """–ü—Ä–µ–æ–±—Ä–∞–∑—É–π —ç—Ç–æ —Ñ–æ—Ç–æ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –∫–∞—Ç–∞–ª–æ–∂–Ω—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –º–µ–±–µ–ª–∏. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä, —Ñ–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º, –∫–∞—á–µ—Å—Ç–≤–æ 4K. –°–æ—Ö—Ä–∞–Ω–∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é, —Ä–∞–∑–º–µ—Ä—ã –∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —à–∫–∞—Ñ–æ–≤ –∏ —Ç–µ—Ö–Ω–∏–∫–∏, –≤—ã—Ä–æ–≤–Ω—è–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ —Ñ–∞—Å–∞–¥–æ–≤. –°–¥–µ–ª–∞–π —Ä–æ–≤–Ω—ã–µ –º–∞—Ç–æ–≤—ã–µ —Ñ–∞—Å–∞–¥—ã –±–µ–∑ –¥–µ—Ñ–µ–∫—Ç–æ–≤, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ —Å—Ç—ã–∫–∏, —Ä–µ–∞–ª–∏—Å—Ç–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Ç–µ–∫—Å—Ç—É—Ä—ã. –î–æ–±–∞–≤—å —Ç–µ–ø–ª—ã–π –º—è–≥–∫–∏–π –±–æ–∫–æ–≤–æ–π —Å–≤–µ—Ç —Å–ª–µ–≤–∞, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º—è–≥–∫–∏–µ —Ç–µ–Ω–∏. –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å—Ç–µ–Ω—ã –∏ –ø–æ—Ç–æ–ª–æ–∫, —Ç–µ–ø–ª—ã–π –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π –ø–æ–ª, —á–∏—Å—Ç–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –°—Ç–∏–ª—å ‚Äî –∏–Ω—Ç–µ—Ä—å–µ—Ä–Ω–∞—è —Ä–µ–∫–ª–∞–º–Ω–∞—è —Ñ–æ—Ç–æ—Å—ä—ë–º–∫–∞ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ –º–µ–±–µ–ª—å–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–∏, —à–∏—Ä–æ–∫–∏–π —É–≥–æ–ª 24‚Äì35 –º–º, –∫–∞–º–µ—Ä–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥–ª–∞–∑, –∏–¥–µ–∞–ª—å–Ω–æ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è"""

ROOM_INTEGRATION_PROMPT = """–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –º–µ–±–µ–ª—å –∏–∑ –ª–µ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä –ø—Ä–∞–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω–∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É –∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫–æ–º–Ω–∞—Ç—ã. –ú–µ–±–µ–ª—å –¥–æ–ª–∂–Ω–∞ –∏–¥–µ–∞–ª—å–Ω–æ –≤–ø–∏—Å–∞—Ç—å—Å—è –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–µ–Ω—è–º–∏ –∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è–º–∏. –§–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º, 4K –∫–∞—á–µ—Å—Ç–≤–æ."""

async def generate_image(prompt: str, image_data: bytes = None) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Nano Banana Pro API"""
    url = "https://api.nanobanana.pro/v1/images/generations"
    
    data = {
        "prompt": prompt,
        "n": 1,
        "size": "1024x1024",
        "response_format": "url"
    }
    
    if image_data:
        data["image"] = image_data
    
    headers = {
        "Authorization": f"Bearer {NANO_API_KEY}",
        "Content-Type": "application/json"
    }
    
    async with aiohttp.ClientSession() as session:
        async with session.post(url, json=data, headers=headers) as response:
            result = await response.json()
            return result['data'][0]['url']

def get_main_keyboard():
    """–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üõãÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–±–µ–ª–∏", callback_data="generate_furniture")],
        [InlineKeyboardButton(text="‚úèÔ∏è –£–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ", callback_data="improve_quality")],
        [InlineKeyboardButton(text="üè† –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É", callback_data="add_to_room")],
        [InlineKeyboardButton(text="üîÑ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç", callback_data="new_project")]
    ])
    return keyboard

def get_furniture_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–±–µ–ª—å—é"""
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ì–æ—Ç–æ–≤–æ, –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É", callback_data="furniture_ready")],
        [InlineKeyboardButton(text="üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", callback_data="regenerate_furniture")],
        [InlineKeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ])
    return keyboard

@dp.message(Command("start"))
async def start_handler(message: types.Message):
    await message.answer(
        "üé® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–±–µ–ª–∏!\n\n"
        "üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å:\n"
        "1Ô∏è‚É£ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —ç—Å–∫–∏–∑ –º–µ–±–µ–ª–∏ (—Ä–∏—Å—É–Ω–æ–∫/—Ñ–æ—Ç–æ)\n"
        "2Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–±–µ–ª–∏' –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –ø—Ä–æ–º—Ç\n"
        "3Ô∏è‚É£ –î–æ—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n"
        "4Ô∏è‚É£ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –∫–æ–º–Ω–∞—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É'",
        reply_markup=get_main_keyboard()
    )

@dp.callback_query(F.data == "main_menu")
async def main_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        "üé® –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_keyboard()
    )
    await callback.answer()

@dp.callback_query(F.data == "generate_furniture")
async def generate_furniture(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(FurnitureStates.waiting_prompt)
    await state.update_data(stage="furniture")
    
    await callback.message.edit_text(
        "üõãÔ∏è –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —ç—Å–∫–∏–∑ –º–µ–±–µ–ª–∏ –∏–ª–∏ —Ñ–æ—Ç–æ –∏ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å.\n"
        "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚ú® –ê–≤—Ç–æ-–∫–∞—Ç–∞–ª–æ–≥", callback_data="auto_catalog")],
            [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="main_menu")]
        ])
    )
    await callback.answer()

@dp.callback_query(F.data == "auto_catalog")
async def auto_catalog(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    
    if 'photo' not in data:
        await callback.answer("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –º–µ–±–µ–ª–∏!", show_alert=True)
        return
    
    photo_bytes = data['photo']
    prompt = FURNITURE_PROMPT
    
    await callback.message.edit_text("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é...")
    
    try:
        image_url = await generate_image(prompt, photo_bytes)
        
        await state.update_data(
            furniture_image=image_url,
            current_prompt=prompt
        )
        
        await callback.message.answer_photo(
            image_url,
            caption="‚úÖ –ú–µ–±–µ–ª—å –≥–æ—Ç–æ–≤–∞!\n–ß—Ç–æ –¥–∞–ª—å—à–µ?",
            reply_markup=get_furniture_keyboard()
        )
    except Exception as e:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
    
    await callback.answer()

@dp.message(FurnitureStates.waiting_prompt)
async def process_furniture_prompt(message: types.Message, state: FSMContext):
    data = await state.get_data()
    
    photo_bytes = None
    custom_prompt = message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ
    if message.photo:
        photo = message.photo[-1]
        photo_bytes = await bot.download_file(photo.file_id)
        photo_bytes = photo_bytes.read()
    
    await state.update_data(
        photo=photo_bytes,
        custom_prompt=custom_prompt
    )
    
    prompt = custom_prompt or FURNITURE_PROMPT
    
    await message.answer("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –º–µ–±–µ–ª—å...")
    
    try:
        image_url = await generate_image(prompt, photo_bytes)
        
        await state.update_data(
            furniture_image=image_url,
            current_prompt=prompt
        )
        
        await message.answer_photo(
            image_url,
            caption="‚úÖ –ú–µ–±–µ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!\n–ß—Ç–æ –¥–∞–ª—å—à–µ?",
            reply_markup=get_furniture_keyboard()
        )
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–º—Ç –∏ —Ñ–æ—Ç–æ.")

@dp.callback_query(F.data == "furniture_ready")
async def furniture_ready(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(FurnitureStates.waiting_room_photo)
    await callback.message.edit_text(
        "üè† –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –∫–æ–º–Ω–∞—Ç—ã, –∫—É–¥–∞ –Ω—É–∂–Ω–æ –≤—Å—Ç—Ä–æ–∏—Ç—å –º–µ–±–µ–ª—å.",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="main_menu")]
        ])
    )
    await callback.answer()

@dp.message(FurnitureStates.waiting_room_photo)
async def process_room_photo(message: types.Message, state: FSMContext):
    data = await state.get_data()
    
    if not message.photo:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –∫–æ–º–Ω–∞—Ç—ã!")
        return
    
    room_photo = message.photo[-1]
    room_bytes = await bot.download_file(room_photo.file_id)
    room_bytes = room_bytes.read()
    
    furniture_url = data.get('furniture_image')
    
    await message.answer("üè† –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É—é –º–µ–±–µ–ª—å –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä...")
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–±–µ–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        async with aiohttp.ClientSession() as session:
            async with session.get(furniture_url) as resp:
                furniture_bytes = await resp.read()
        
        final_prompt = ROOM_INTEGRATION_PROMPT
        
        final_image_url = await generate_image(final_prompt, room_bytes)
        
        await message.answer_photo(
            final_image_url,
            caption="üéâ –ì–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ú–µ–±–µ–ª—å –∏–¥–µ–∞–ª—å–Ω–æ –≤–ø–∏—Å–∞–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞.",
            reply_markup=get_main_keyboard()
        )
        
        await state.clear()
        
    except Exception as e:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–æ–º–Ω–∞—Ç—É.")

@dp.callback_query(F.data == "regenerate_furniture")
async def regenerate_furniture(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    prompt = data.get('current_prompt', FURNITURE_PROMPT)
    
    await callback.message.edit_caption(
        caption="üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é –º–µ–±–µ–ª—å...",
        reply_markup=None
    )
    
    try:
        image_url = await generate_image(prompt)
        await state.update_data(furniture_image=image_url)
        
        await callback.message.edit_caption(
            caption="‚úÖ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≥–æ—Ç–æ–≤–∞!\n–ß—Ç–æ –¥–∞–ª—å—à–µ?",
            reply_markup=get_furniture_keyboard()
        )
        await callback.message.delete()
        await callback.message.answer_photo(
            image_url,
            caption="‚úÖ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≥–æ—Ç–æ–≤–∞!\n–ß—Ç–æ –¥–∞–ª—å—à–µ?",
            reply_markup=get_furniture_keyboard()
        )
    except Exception:
        await callback.message.answer("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.")
    
    await callback.answer()

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
